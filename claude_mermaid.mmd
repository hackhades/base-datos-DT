erDiagram
    %% =================== USUARIOS Y AUTENTICACIÓN ===================
    users {
        int id PK
        string email UK
        string password_hash
        string first_name
        string last_name
        string phone
        string country
        string city
        date birth_date
        boolean is_active
        timestamp created_at
    }

    license_types {
        int id PK
        string name
        decimal monthly_price
        decimal annual_price
        int max_sessions
        jsonb features
    }

    user_licenses {
        int id PK
        int user_id FK
        int license_type_id FK
        string payment_type
        timestamp start_date
        timestamp end_date
        boolean is_active
    }

    active_sessions {
        int id PK
        int user_id FK
        string session_token UK
        inet ip_address
        timestamp last_activity
        boolean is_active
    }

    %% =================== ORGANIZACIONES ===================
    organization_types {
        int id PK
        string name
        int hierarchy_level
    }

    organizations {
        int id PK
        string name
        int organization_type_id FK
        int parent_organization_id FK
        string country
        string email
        boolean is_verified
        timestamp verification_date
        int verified_by FK
    }

    user_roles {
        int id PK
        string name
        jsonb permissions
    }

    user_organization_roles {
        int id PK
        int user_id FK
        int organization_id FK
        int role_id FK
        boolean is_verified
        int verified_by FK
    }

    %% =================== JUGADORES Y ÁRBITROS ===================
    players {
        int id PK
        int user_id FK
        string player_number
        int elo_rating_official
        int elo_rating_open
        int games_played_official
        int games_played_open
        int wins_official
        int wins_open
        int preferred_partner FK
        jsonb achievements
    }

    referees {
        int id PK
        int user_id FK
        string referee_number
        string certification_level
        date certification_date
        int certifying_organization_id FK
        jsonb languages
        int tournaments_officiated
        boolean is_active
    }

    %% =================== TORNEOS Y PARTIDAS ===================
    game_modes {
        int id PK
        string name
        int min_players
        int max_players
        boolean is_team_mode
        string license_required
        jsonb rules
    }

    tournaments {
        int id PK
        string name
        int organizing_entity_id FK
        int organized_by FK
        int game_mode_id FK
        string tournament_type
        string status
        timestamp start_date
        timestamp end_date
        int max_participants
        decimal entry_fee
        boolean is_rated
    }

    tournament_registrations {
        int id PK
        int tournament_id FK
        int player1_id FK
        int player2_id FK
        string team_name
        string status
        string payment_status
        int seeding_number
    }

    tournament_rounds {
        int id PK
        int tournament_id FK
        int round_number
        string round_name
        string status
        timestamp start_time
    }

    matches {
        int id PK
        int tournament_id FK
        int round_id FK
        int team1_player1_id FK
        int team1_player2_id FK
        int team2_player1_id FK
        int team2_player2_id FK
        int referee_id FK
        string status
        timestamp scheduled_time
        int team1_score
        int team2_score
        int winner_team
    }

    games {
        int id PK
        int match_id FK
        int game_number
        int team1_score
        int team2_score
        int winner_team
        int duration_minutes
    }

    %% =================== RANKINGS Y ESTADÍSTICAS ===================
    elo_history {
        int id PK
        int player_id FK
        int match_id FK
        string rating_type
        int old_rating
        int new_rating
        int rating_change
        int opponent1_id FK
        int opponent2_id FK
        string result
    }

    rankings {
        int id PK
        string ranking_type
        int player_id FK
        int organization_id FK
        int current_rating
        int position
        int games_played
        int wins
        decimal win_percentage
        boolean is_active
    }

    %% =================== PAGOS Y SISTEMA ===================
    payments {
        int id PK
        int user_id FK
        int license_id FK
        int tournament_id FK
        string payment_type
        decimal amount
        string status
        timestamp payment_date
    }

    notifications {
        int id PK
        int user_id FK
        string title
        text message
        string type
        boolean is_read
        timestamp created_at
    }

    system_config {
        int id PK
        string config_key UK
        text config_value
        string data_type
    }

    %% =================== RELACIONES ===================
    
    %% Usuarios y Licencias
    users ||--o{ user_licenses : "tiene"
    license_types ||--o{ user_licenses : "tipo"
    users ||--o{ active_sessions : "sesiones"
    
    %% Organizaciones
    organization_types ||--o{ organizations : "tipo"
    organizations ||--o{ organizations : "parent/child"
    users ||--o{ user_organization_roles : "pertenece"
    organizations ||--o{ user_organization_roles : "tiene"
    user_roles ||--o{ user_organization_roles : "rol"
    users ||--o{ organizations : "verifica"
    
    %% Jugadores y Árbitros
    users ||--|| players : "es"
    users ||--|| referees : "es"
    players ||--o{ players : "compañero_preferido"
    organizations ||--o{ referees : "certifica"
    
    %% Torneos
    organizations ||--o{ tournaments : "organiza"
    users ||--o{ tournaments : "organizador"
    game_modes ||--o{ tournaments : "modalidad"
    tournaments ||--o{ tournament_registrations : "inscripciones"
    players ||--o{ tournament_registrations : "jugador1"
    players ||--o{ tournament_registrations : "jugador2"
